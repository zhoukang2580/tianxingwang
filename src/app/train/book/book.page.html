<ion-header>
  <ion-toolbar>
    <ion-buttons slot='start'>
      <ion-button (click)='back()'>
        <ion-icon color='dark' name='arrow-back'></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>确认信息</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ng-container *ngIf='!error else retryTempl'>
    <ion-refresher slot='fixed' (ionRefresh)='doRefresh()'></ion-refresher>
    <ion-item-group *ngFor="let combindInfo of viewModel?.combindInfos">
      <ion-item-divider color='primary' sticky>
        {{combindInfo?.credential?.CheckName}}
        【{{tmc?.Name}}】
        [成人]
        {{combindInfo?.credential?.Number}}
      </ion-item-divider>
      <ion-item lines='none' class="ion-no-margin">
        <ion-label>通知语言:</ion-label>
        <ion-select value='cn' okText="确定" cancelText="取消" [(ngModel)]='combindInfo.notifyLanguage'>
          <ion-select-option value=''>不发</ion-select-option>
          <ion-select-option value='cn'>中文</ion-select-option>
          <ion-select-option value='en'>英文</ion-select-option>
        </ion-select>
      </ion-item>
      <ion-item lines='none' class="ion-no-margin" *ngIf='viewModel?.isCanSkipApproval$|async'>
        <ion-label style='margin-right: 0.5em'>跳过审批:</ion-label>
        <ion-checkbox margin-end color="secondary" [(ngModel)]='combindInfo.isSkipApprove'></ion-checkbox>
      </ion-item>
      <ion-item lines='none' class="ion-no-margin"
        *ngIf='tmc?.IsShowServiceFee || viewModel?.identity?.Numbers?.AgentId'>
        <ion-label>服务费:</ion-label>
        <ion-label slot='end' text-end padding-end>{{getServiceFee(combindInfo)}}</ion-label>
      </ion-item>
      <ion-item class="ion-no-margin" lines='none' detail *ngIf='isAllowSelectApprove(combindInfo)'
        (click)='openApproverModal(combindInfo)'>
        <ion-label>
          审批人:<ion-text *ngIf='combindInfo?.appovalStaff'>
            {{combindInfo?.appovalStaff?.Name}}|{{combindInfo?.appovalStaff?.Email||combindInfo?.appovalStaff?.Account?.Email}}|{{combindInfo?.appovalStaff?.Number||combindInfo?.appovalStaff?.Mobile}}
          </ion-text>
        </ion-label>
      </ion-item>
      <ion-item>
        <div>
          <ion-button fill='clear' class='change-policy-btn' (click)='onOpenrules(combindInfo)' color='secondary'>
            退改签政策
            <ion-icon name="arrow-dropdown" *ngIf='combindInfo?.isOpenrules'></ion-icon>
            <ion-icon name="arrow-dropright" *ngIf='!combindInfo?.isOpenrules'></ion-icon>
          </ion-button>
        </div>
      </ion-item>
      <div style='width: 100%' *ngIf='combindInfo?.vmCredential'>
        <app-book-credential-comp [credential]='combindInfo?.vmCredential'
          (savecredential)='onSavecredential($event,combindInfo)' [credentials]='combindInfo?.credentials'
          (modify)='onModify(combindInfo)'>
        </app-book-credential-comp>
        <div *ngIf='combindInfo?.bookInfo?.trainInfo?.trainPolicy?.Rules?.length && !combindInfo?.isNotWhitelist'>
          <app-book-illegal-reason-comp #illegalReasonsEle [illegalReasons]='viewModel?.illegalReasons'
            [isAllowCustomReason]='tmc?.IsAllowCustomReason' (ionchange)='onIllegalReason($event,combindInfo)'>
          </app-book-illegal-reason-comp>
        </div>
        <app-book-costcenter-comp [isOtherCostCenter]='combindInfo.isOtherCostCenter'
          [costCenter]='combindInfo.costCenter' [otherCostCenterCode]='combindInfo.otherCostCenterCode'
          [otherCostCenterName]='combindInfo.otherCostCenterName' (ionChange)='onCostCenterChange($event,combindInfo)'>
        </app-book-costcenter-comp>
        <app-book-organization-comp (ionChange)='onOrganizationChange($event,combindInfo)'
          [organization]='combindInfo?.organization' [isOtherOrganization]='combindInfo?.isOtherOrganization'
          [otherOrganizationName]='combindInfo?.otherOrganizationName'></app-book-organization-comp>
        <div class='mobiles'>
          联系方式:
          <ion-item *ngFor='let mobile of combindInfo?.credentialStaffMobiles'>
            <ion-checkbox color="secondary" [(ngModel)]="mobile.checked"></ion-checkbox>
            <ion-label style='margin-left: 0.5em'>{{mobile.mobile}}</ion-label>
          </ion-item>
          <ion-item>
            <ion-label style='margin-right: 0.5em'>其他号码：</ion-label>
            <ion-input [(ngModel)]="combindInfo.credentialStaffOtherMobile" placeholder='请输入其他号码'></ion-input>
          </ion-item>
        </div>
        <div class='emails'>
          联系邮箱:
          <ion-item *ngFor='let email of combindInfo?.credentialStaffEmails'>
            <ion-checkbox color="secondary" [(ngModel)]="email.checked"></ion-checkbox>
            <ion-label style='margin-left: 0.5em'>{{email.email}}</ion-label>
          </ion-item>
          <ion-item>
            <ion-label style='margin-right: 0.5em'>其他邮箱：</ion-label>
            <ion-input [(ngModel)]="combindInfo.credentialStaffOtherEmail" placeholder='请输入其他邮箱'></ion-input>
          </ion-item>
        </div>
        <div *ngIf='combindInfo?.insuranceProducts?.length'>
          保险:
          <div *ngFor='let insurance of combindInfo?.insuranceProducts'>
            <ion-row>
              <ion-col size='9'>
                <ion-item>
                  <ion-checkbox color="secondary" name='insurance' [(ngModel)]="insurance.checked">
                  </ion-checkbox> 
                  <ion-label style='margin-left: 0.5em'>
                    {{insurance.insuranceResult?.Name}}({{insurance.insuranceResult?.Price}}元)</ion-label>
                </ion-item>
              </ion-col>
              <ion-col size='3'>
                <ion-button fill='clear' (click)='insuranceEle.checked=!insuranceEle.checked' color='secondary'>
                  详情
                  <ion-icon name="arrow-dropdown" *ngIf='insuranceEle.checked'></ion-icon>
                  <ion-icon name="arrow-dropright" *ngIf='!insuranceEle.checked'></ion-icon>
                </ion-button>
              </ion-col>
            </ion-row>
            <input type="checkbox" #insuranceEle class='hidden'>
            <ion-label text-wrap class='small-font' [@showHide]='insuranceEle.checked'>
              {{insurance.insuranceResult?.Detail}}
            </ion-label>
          </div>
        </div>
        <div *ngIf="isShowApprove()" class='ion-margin-top'>
          审批人:
          <ion-row style='margin-top: .5em;'>
            <ion-col>
              <app-timeline [hideLastTimeLineTail]='false'>
                <app-timeline-item *ngFor='let it of combindInfo?.credentialStaffApprovers'>
                  第{{it.Tag}}级审批:
                  <ion-label text-wrap *ngFor='let ap of it.approvers;let last'>
                    {{ap.Name}}({{it?.Type==1?"所有通过":"任意通过"}})
                  </ion-label>
                </app-timeline-item>
              </app-timeline>
            </ion-col>
          </ion-row>
        </div>
      </div>
      <div class='outnumber ion-margin-top' *ngIf='combindInfo?.tmcOutNumberInfos'>
        外部编号：
        <ion-item-group>
          <ion-item *ngFor='let n of combindInfo?.tmcOutNumberInfos' (click)='onSelectTravelNumber(n,combindInfo)'>
            <ion-label>{{n.label}}:</ion-label>
            <ion-input [disabled]='n.isDisabled' [value]='n.value' [(ngModel)]='n.value' placeholder="{{n.label}}">
            </ion-input>
          </ion-item>
          <ion-item style='height:0'></ion-item>
        </ion-item-group>
      </div>

      <div class='ion-margin-top'>
        支付方式：
        <ion-radio-group [(ngModel)]='combindInfo.orderTravelPayType' name='travelPayType'>
          <ion-item *ngFor='let pt of viewModel?.orderTravelPayTypes' lines='none'>
            <ion-label>{{pt.label}}</ion-label>
            <ion-radio [value]="pt.value" [checked]='combindInfo.orderTravelPayType==pt.value'>
            </ion-radio>
          </ion-item>
        </ion-radio-group>
      </div>
      <app-book-addcontacts-comp [addContacts]='combindInfo?.addContacts'
        (contactChange)='onContactsChange($event,combindInfo)'></app-book-addcontacts-comp>
    </ion-item-group>
  </ng-container>
  <ng-template #retryTempl>
    <ion-row style="position: relative;top:35%">
      <ion-col text-center>
        <ion-label color='danger'>请求数据出错</ion-label>
        <ion-button fill='clear' expand='block' color='secondary' (click)='doRefresh()'>点击重试</ion-button>
      </ion-col>
    </ion-row>
  </ng-template>
</ion-content>
<ion-footer>
  <ion-toolbar>
    <ion-buttons slot='start'>
      <ion-button color='secondary'>总计:
        <ion-text slot='end' color='danger'>￥{{(totalPriceSource|async)}}</ion-text>
      </ion-button>
    </ion-buttons>
    <ion-buttons slot='end'>
      <ion-button color='secondary' (click)='bookTrain()'> 提交</ion-button>
    </ion-buttons>
    <ion-buttons slot='end'>
      <ion-button color='secondary' (click)='bookTrain(true)'>保存订单</ion-button>
    </ion-buttons> 
  </ion-toolbar>
</ion-footer>