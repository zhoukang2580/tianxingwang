<ion-header>
  <ion-toolbar>
    <ion-buttons slot='start'>
      <app-back-button defaultHref=""></app-back-button>
    </ion-buttons>
    <ion-title>{{title}}</ion-title>
  </ion-toolbar>
</ion-header>
<ion-content>
  <app-swiper-slide-content [tabs]="tabs">
    <ng-container *ngIf='orderDetail&&orderDetail.Order else nomoredata'>
      <div class="swiper-slide" #slide>
        <!-- 订单信息 -->
        <div>
          <ion-item-divider>
            {{tabs[0]?.label}}
          </ion-item-divider>
          <div>
            <ion-row>
              <ion-col size='3'>订单编号:</ion-col>
              <ion-col>{{orderDetail.Order.Id}}</ion-col>
            </ion-row>
            <ion-row>
              <ion-col size='3'>订单状态:</ion-col>
              <ion-col>{{orderDetail.Order.StatusName == "等待处理" ? "等待审批" : orderDetail.Order.StatusName}}
              </ion-col>
            </ion-row>
            <ion-row>
              <ion-col size='3'>付款方式:</ion-col>
              <ion-col>{{orderDetail.TravelType}}-{{orderDetail.TravelPayType}}</ion-col>
            </ion-row>
            <ion-row>
              <ion-col size='3'>完成时间:</ion-col>
              <ion-col>{{orderDetail.Order.InsertDateTime}}</ion-col>
            </ion-row>
            <ion-row (click)='showPricePopover()' *ngIf='orderDetail.Order?.Type=="Flight"'>
              <ion-col size='3'>应付金额:</ion-col>
              <ion-col>
                <div>
                  {{getOrderTotalAmount()}}
                  <span *ngIf='getInsuranceAmount() as insuranceAmount'>(含保险{{insuranceAmount}})</span>
                </div>
              </ion-col>
              <ion-col size='2'>
                <ion-icon name="chevron-forward-outline" mode='ios'>
                </ion-icon>
              </ion-col>
            </ion-row>
            <ng-container>
              <ng-container *ngIf='tmc?.IsShowServiceFee'>
                <ion-row *ngFor='let orderHotel of orderDetail.Order.OrderHotels'>
                  <ion-col size='3'>
                    <ng-container *ngIf='orderDetail.Order.OrderHotels.length>1'>
                      <strong *ngIf='orderHotel.HotelName as n'>
                        {{n.length>10?n.substr(0,10)+"...":n}}
                      </strong>
                    </ng-container>
                    服务费:
                  </ion-col>
                  <ion-col>{{getHotelServiceFee(orderHotel.Key)}}
                  </ion-col>
                </ion-row>
              </ng-container>
            </ng-container>
            <ion-row>
              <ion-col size='3'>已付金额:</ion-col>
              <ion-col>{{getOrderPayAmount()}}</ion-col>
            </ion-row>
          </div>

        </div>
      </div>
      <div class="swiper-slide" #slide>
        <!-- 出行信息 -->
        <div>
          <ng-container *ngIf='orderDetail.Order.OrderFlightTickets?.length'>
            <ng-container *ngIf='getTravelFlightTrips() as trips'>
              <div>
                <ion-item-divider>
                  <ion-text>航班信息</ion-text>
                </ion-item-divider>
              </div>
              <app-flight-order-detail [trips]='trips' [order]='orderDetail.Order'></app-flight-order-detail>
            </ng-container>
          </ng-container>
          <ng-container *ngIf='orderDetail.Order.OrderTrainTickets?.length'>
            <div>
              <ion-item-divider>
                <ion-text color=''>火车车次信息</ion-text>
              </ion-item-divider>
            </div>
            <app-train-order-detail [trainTickets]='orderDetail.Order.OrderTrainTickets'
              [passengerId]='selectedTrainTicket?.Passenger?.Id' [order]='orderDetail.Order'>
            </app-train-order-detail>
          </ng-container>
          <ng-container *ngIf='orderDetail.Order.OrderHotels?.length'>
            <div>
              <ion-item-divider>
                酒店信息
              </ion-item-divider>
            </div>
            <app-hotel-order-detail [hotels]='orderDetail.Order.OrderHotels' [order]='orderDetail.Order'>
            </app-hotel-order-detail>
          </ng-container>
        </div>
      </div>
      <div class="swiper-slide" #slide>
        <!-- 旅客信息 -->
        <div>
          <ion-item-divider>{{tabs[2]?.label}}
            <ng-container *ngIf='orderDetail.Order?.OrderFlightTickets?.length>1'>
              <ion-badge color='danger'>
                {{orderDetail.Order.OrderFlightTickets?.length}}</ion-badge>
              <ion-select slot='end' [compareWith]='compareFn' (ionChange)='onSelectFlightTicket($event)'
                [(ngModel)]='selectedFlightTicket' [okText]='"确定"' [cancelText]='"取消"'>
                <ion-label>{{selectedFlightTicket?.Id}}</ion-label>
                <ion-select-option *ngFor='let o of orderDetail.Order.OrderFlightTickets' [value]='o'>{{o.Id}}
                </ion-select-option>
              </ion-select>
            </ng-container>
            <ng-container *ngIf='orderDetail.Order?.OrderTrainTickets?.length>1'>
              <ion-badge color='danger'>
                {{orderDetail.Order.OrderTrainTickets?.length}}</ion-badge>
              <ion-select slot='end' [compareWith]='compareFn' (ionChange)='onSelectTrainTicket($event)'
                [(ngModel)]='selectedTrainTicket' [okText]='"确定"' [cancelText]='"取消"'>
                <ion-label>{{selectedTrainTicket?.Id}}</ion-label>
                <ion-select-option *ngFor='let o of orderDetail.Order.OrderTrainTickets' [value]='o'>{{o.Id}}
                </ion-select-option>
              </ion-select>
            </ng-container>
          </ion-item-divider>
          <div>
            <ng-container lines='none' class='customer'>
              <ng-container *ngIf='getPassengerCostOrgInfo() as info'>
                <div *ngIf='info.Passenger as p'>
                  <div style='width: 100%' class='passenger-info'>
                    <ion-row>
                      <ion-col size='3'>姓名</ion-col>
                      <ion-col>{{p.CheckName}} <span
                          *ngIf='orderDetail.Order.Type?.toLowerCase()!="hotel"&& p.PassengerTypeName'>({{p.PassengerTypeName}})</span>
                      </ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size='3'>证件号码</ion-col>
                      <ion-col>{{p.CredentialsNumber}}</ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size='3'>联系电话</ion-col>
                      <ion-col>{{p.Mobile}}</ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size='3'>邮箱</ion-col>
                      <ion-col>{{p.Email}}</ion-col>
                    </ion-row>
                    <ion-row>
                      <ion-col size='3'>费用类别</ion-col>
                      <ion-col>{{getExpenseType()}}</ion-col>
                    </ion-row>
                    <ng-container>
                      <ion-row>
                        <ion-col size='3'>成本中心</ion-col>
                        <ion-col>{{info.CostCenterCode}}-{{info.CostCenterName}}</ion-col>
                      </ion-row>
                      <ion-row>
                        <ion-col size='3'>组织架构</ion-col>
                        <ion-col>{{info.OrganizationCode}}-{{info.OrganizationName}}</ion-col>
                      </ion-row>
                      <ion-row>
                        <ion-col size='3'>外部编号</ion-col>
                        <ion-col>
                          <div *ngFor='let n of info.OutNumbers'>
                            <span>{{n.Name}}:{{n.Number}}</span>
                          </div>
                        </ion-col>
                      </ion-row>
                      <ion-row>
                        <ion-col size='3'>违规</ion-col>
                        <ion-col>{{info.IllegalPolicy}}</ion-col>
                      </ion-row>
                      <ion-row>
                        <ion-col size='3'>违规原因</ion-col>
                        <ion-col>{{info.IllegalReason}}</ion-col>
                      </ion-row>
                      <ng-container *ngIf='orderDetail.Order?.OrderHotels as OrderHotels'>
                        <ion-row>
                          <ion-col size='3'>其他入住人</ion-col>
                          <ion-col>
                            <ng-container *ngFor='let it of OrderHotels;let i=index;let last=last'>
                              <div *ngIf='it.Type==OrderHotelType.International'>
                                <div
                                  *ngIf='it.CustomerName?.substring(it.CustomerName?.indexOf("/")+1)?.replace(","," ") as n'>
                                  <ion-text class="ion-margin-end">
                                    {{n}}
                                  </ion-text>
                                </div>
                                <div *ngIf='it.ChildrenName.replace(","," ") as n '>
                                  <ion-text class="ion-margin-end">
                                    {{n}}
                                  </ion-text>
                                </div>
                              </div>
                            </ng-container>
                          </ion-col>
                        </ion-row>
                      </ng-container>
                    </ng-container>
                    <ion-row *ngIf='canSendEmailMsg()'>
                      <ion-col>
                        <ion-button no-margin size='small' color='secondary' (click)='sendMsg(p)'>
                          <ion-icon name="create-outline" mode='ios' slot='start'></ion-icon>
                          发送短信
                        </ion-button>
                      </ion-col>
                      <ion-col>
                        <ion-button no-margin size='small' color='secondary' (click)='sendEmail(p)'>
                          <ion-icon name="mail" mode='ios' slot='start'></ion-icon>
                          发送邮件
                        </ion-button>
                      </ion-col>
                    </ion-row>
                  </div>
                </div>
              </ng-container>

            </ng-container>
          </div>
        </div>
      </div>

      <div class="swiper-slide" #slide>
        <!-- 审批记录 -->
        <div>
          <div>
            <ion-item-divider>{{tabs[3]?.label}}</ion-item-divider>
          </div>
          <div>
            <app-timeline [hideLastTimeLineTail]='false' *ngIf='orderDetail.Histories?.length'>
              <app-timeline-item *ngFor='let history of orderDetail.Histories'>
                <div class='approval-info'>
                  <div>审批类型：{{getVariableObj(history,"TypeName")}}</div>
                  <div>审批人：{{history.Account?.RealName}} <span
                      *ngIf='history.StatusName'>({{history.StatusName}})</span>
                  </div>
                  <div>发起审批时间：{{history?.InsertDateTime}}</div>
                  <div>审批截止时间：{{history?.ExpiredTime?.startsWith("1800")?"":history?.ExpiredTime}}</div>
                </div>
              </app-timeline-item>
            </app-timeline>
          </div>
        </div>
      </div>
      <div class="swiper-slide" #slide>
        <!-- 联系信息 -->
        <div>
          <ion-item-divider>{{tabs[4]?.label}} </ion-item-divider>
          <div *ngFor='let item of orderDetail.Order.OrderPassengers'>
            <ion-row>
              <ion-col size='3'>类型</ion-col>
              <ion-col>旅客</ion-col>
            </ion-row>
            <ion-row>
              <ion-col size='3'>姓名</ion-col>
              <ion-col>{{item.Name}}</ion-col>
            </ion-row>
            <ion-row>
              <ion-col size='3'>邮箱</ion-col>
              <ion-col>{{item.Email}}</ion-col>
            </ion-row>
            <ion-row>
              <ion-col size='3'>电话</ion-col>
              <ion-col>{{item.Mobile}}</ion-col>
            </ion-row>
          </div>
          <div *ngFor='let item of orderDetail.Order.OrderLinkmans;let i=index;'>
            <ion-row>
              <ion-col size='3'>类型</ion-col>
              <ion-col>联系人{{i+1}}</ion-col>
            </ion-row>
            <ion-row>
              <ion-col size='3'>姓名</ion-col>
              <ion-col>{{item.Name}}</ion-col>
            </ion-row>
            <ion-row>
              <ion-col size='3'>邮箱</ion-col>
              <ion-col>{{item.Email}}</ion-col>
            </ion-row>
            <ion-row>
              <ion-col size='3'>电话</ion-col>
              <ion-col>{{item.Mobile}}</ion-col>
            </ion-row>
          </div>
        </div>
      </div>
      <div class="swiper-slide" #slide *ngIf='"Flight"==orderDetail.Order.Type||"Train"==orderDetail.Order.Type'>
        <!-- 保险信息 *ngIf='(tab?.value == ProductItemType.train)||(tab?.value ==ProductItemType.plane)'-->
        <div>
          <div>
            <ion-item-divider>{{tabs[5]?.label}}
              <ng-container *ngIf='orderDetail.Order.OrderInsurances?.length>1'>
                <ion-badge color='danger'>
                  {{orderDetail.Order.OrderInsurances?.length}}</ion-badge>
                <ion-select slot='end' [(ngModel)]='selectedInsuranceId' [okText]='"确定"' [cancelText]='"取消"'>
                  <ion-label>{{selectedInsuranceId}}</ion-label>
                  <ion-select-option *ngFor='let o of orderDetail.Order.OrderInsurances' [value]='o.Id'>{{o.Id}}
                  </ion-select-option>
                </ion-select>
              </ng-container>
            </ion-item-divider>
          </div>
          <div lines='none' *ngIf="orderDetail.Order.OrderInsurances?.length&&orderDetail.Order.OrderTravels">
            <app-insurance-order-detail [order]='orderDetail.Order' [selectedInsuranceId]='selectedInsuranceId'>
            </app-insurance-order-detail>
          </div>
        </div>
      </div>
    </ng-container>
  </app-swiper-slide-content>
  <ng-template #nomoredata>
    <span *ngIf='isLoading'>
      正在获取订单详情...
    </span>
    <app-or-comp *ngIf='!isLoading'>暂无数据</app-or-comp>
  </ng-template>
</ion-content>