<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
    <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css" />
    <style>
        body {
            margin: 0;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        button {
            padding: .5em 1em;
            color: white;
            background-color: tomato;
            border: none;
            border-radius: 5px;
            position: fixed;
            right: 0;
            bottom: 6vh;
            z-index: 99;

        }
    </style>
</head>

<body>
    <button onclick="onToggle()">显示/隐藏</button>
    <script src="mockcities.js"></script>
    <script>
        isShow = false;
        let allItems = [];
        let page;
        const cities = window.cities;
        let histories = [];
        onToggle();
        function onToggle() {
            isShow = !isShow;
            openPage(isShow)
        }
        function getHeaderHtml() {
            const header = document.createElement("div");
            header.classList.add("header");
            const backIcon = document.createElement("ion-icon");
            backIcon.setAttribute("name", "chevron-back-outline");
            backIcon.setAttribute("slot", "start");
            const cancelBtn = document.createElement("ion-button");
            cancelBtn.setAttribute("color", "secondary");
            cancelBtn.setAttribute("fill", "clear");
            cancelBtn.setAttribute("size", "small");
            cancelBtn.classList.add("cancel")
            const label = document.createElement("ion-label");
            label.textContent = '取消';
            cancelBtn.append(label);
            cancelBtn.onclick = () => {
                this.openPage(false);
            };
            backIcon.onclick = () => {
                this.openPage(false);
            };
            const searchbar = document.createElement("ion-searchbar");
            searchbar.setAttribute("disabled", "true");
            header.append(backIcon);
            header.append(searchbar);
            header.append(cancelBtn);
            return header;
        }
        function openPage(open) {
            page = document.body.querySelector(".hotel-city-page-container");
            if (!page) {
                page = getHtml();
                const fabbtn = document.body.querySelector(".fab-btn.hotel-city-page-container");
                page.onscroll = () => {
                    if (fabbtn) {
                        if (page.scrollTop > 0.6 * window.innerHeight) {
                            fabbtn.classList.add("show");
                        } else {
                            fabbtn.classList.remove("show");
                        }
                    }
                }
            }
            if (page) {
                if (open) {
                    page.classList.add("show")
                } else {
                    page.classList.remove("show")
                }
            }
        }
        function getHistoryHtml(cities) {
            const rowNums = 3;
            const wrapper = document.createElement("div");
            try {
                wrapper.classList.add("hot-cities-wrapper");
                wrapper.classList.add("history-cities-wrapper");
                if (!cities || !cities.length) { return wrapper };
                const header = document.createElement("div");
                header.classList.add("header");
                const label = document.createElement("label");
                label.textContent = '历史记录';
                header.append(label);
                const rmicon = document.createElement("ion-icon");
                rmicon.classList.add("icon");
                rmicon.setAttribute("name", 'trash-outline');
                rmicon.onclick = () => {
                    onClearHistories();
                }
                header.append(rmicon);
                wrapper.append(header);
                const list = document.createElement("div");
                const listWrapper = document.createElement("div");
                listWrapper.classList.add("list-wrapper");
                listWrapper.append(list);
                list.classList.add("list");
                wrapper.append(listWrapper)
                cities.slice(0, 20).forEach(c => {
                    const item = getHistoryOrHotItem(c, true);
                    const label = document.createElement("label");
                    label.textContent = c.Name;
                    item.onclick = () => {
                        onSelectCity(c);
                    }
                    list.append(item);
                })
                if (cities.length % rowNums != 0) {
                    const len = cities.length % rowNums;
                    const item = document.createElement('div');
                    item.classList.add("empty-item");
                    item.classList.add("b-item");
                    item.style.visibility = 'collapse'
                    for (let i = 0; i < len; i++) {
                        list.append(item);
                    }
                }
            } catch (e) {
                console.error(e)
            }
            return wrapper;

        }
        function getHistoryOrHotItem(c, isHistory) {
            const item = document.createElement("div");
            item.classList.add("b-item");
            item.textContent = c.Name;
            item.setAttribute("CityCode", c.CityCode);
            item.onclick = () => {
                if (!isHistory) {
                    onSelectCity(c);
                }
            }
            return item;
        }
        function getScrollToTopFab() {
            const fab = document.createElement("div");
            fab.classList.add("fab-btn");
            fab.classList.add("hotel-city-page-container");
            const icon = document.createElement("ion-icon");
            icon.setAttribute("name", 'chevron-up-outline');
            fab.append(icon);
            fab.onclick = () => {
                page.scrollTop = 0;
            }
            return fab;
        }
        function getHotHtml(cities) {
            const rowNums = 3;
            const wrapper = document.createElement("div");
            try {
                wrapper.classList.add("hot-cities-wrapper");
                const header = document.createElement("div");
                header.classList.add("header");
                const label = document.createElement("label");
                label.textContent = '热门城市';
                header.append(label);
                wrapper.append(header);
                const list = document.createElement("div");
                const listWrapper = document.createElement("div");
                listWrapper.classList.add("list-wrapper");
                listWrapper.append(list);
                list.classList.add("list");
                wrapper.append(listWrapper)
                cities.forEach(c => {
                    const item = getHistoryOrHotItem(c);
                    const label = document.createElement("label");
                    label.textContent = c.Name;
                    item.onclick = () => {
                        onSelectCity(c);
                    }
                    list.append(item);
                })
                if (cities.length % rowNums != 0) {
                    const len = cities.length % rowNums;
                    const item = document.createElement('div');
                    item.classList.add("empty-item");
                    item.classList.add("b-item");
                    item.style.visibility = 'collapse'
                    for (let i = 0; i < len; i++) {
                        list.append(item);
                    }
                }
            } catch (e) {
                console.error(e)
            }
            return wrapper;
        }
        function onShowInHistory(c) {
            try {
                if (page) {
                    let wrapper = getHistoryWrapperEl();
                    if (!wrapper) {
                        wrapper = getHistoryHtml();
                        page.insertBefore(wrapper, page.querySelector(".hot-cities-wrapper"))
                    }
                    const items = wrapper.querySelectorAll(".b-item");
                    const list = wrapper.querySelector(".list");
                    if (!histories || !histories.length) {
                        histories = [c];
                    }
                    if (histories.length >= 12) {
                        histories.pop();
                    } else if (!histories.find(it => it.Code == c.Code)) {
                        histories.unshift(c);
                    }
                    const item = getHistoryOrHotItem(c);
                    item.setAttribute("history", 'isHistory');
                    if (wrapper) {
                        if (items.length) {
                            for (let i = 0; i < items.length; i++) {
                                const one = items.item(i);
                                if (one.getAttribute("CityCode") == c.CityCode) {
                                    list.insertBefore(one, list.firstChild);
                                    return;
                                }
                            }
                            if (items && items.length >= 12) {
                                if (list) {
                                    list.removeChild(items.item(items.length - 1))
                                }
                            }
                            list.insertBefore(item, list.firstChild);
                        } else {
                            page.removeChild(wrapper);
                            wrapper = getHistoryHtml(histories);
                            page.insertBefore(wrapper, page.querySelector(".hot-cities-wrapper"))
                        }
                    }
                }
            } catch (e) {
                console.error(e)
            }
        }
        function getHistoryWrapperEl() {
            return page && page.querySelector(".history-cities-wrapper");
        }
        function onSelectCity(c) {
            onShowInHistory(c);
            console.log(c);
        }
        function onClearHistories() {
            if (page) {
                const history = getHistoryWrapperEl();
                histories = [];
                if (history) {
                    if (history.firstChild) {
                        history.removeChild(history.firstChild);
                    }
                    page.removeChild(history)
                }
            }
        }
        function getHtml() {
            const cmap = getLeter2Cities(cities);
            const page = document.createElement("div");
            page.classList.add("hotel-city-page-container");
            const hotHtml = getHotHtml(cities.filter(it => it.IsHot));
            const historyHtml = getHistoryHtml();
            const header = getHeaderHtml();
            page.append(header);
            page.append(historyHtml);
            page.append(hotHtml);
            const letterNavs = getLetterNavs(cmap);
            page.append(letterNavs)
            const list = getList(cmap);
            page.append(list);
            document.body.append(page);
            document.body.append(getScrollToTopFab());
            return page;
        }
        function getLetterNavs(cmap) {
            const letters = Object.keys(cmap);
            letters.sort();
            const letterDiv = document.createElement("div");
            const divwrapper = document.createElement("div");
            divwrapper.classList.add("letters-wrapper")
            letterDiv.classList.add("letter-navs");
            divwrapper.append(letterDiv);
            letters.forEach(l => {
                const li = document.createElement("div");
                li.classList.add("nav-letter")
                li.textContent = l;
                letterDiv.append(li);
                li.onclick = (evt) => {
                    if (evt) {
                        evt.stopPropagation();
                    }
                    try {
                        const el = page.querySelector(`[letter='${l}']`);
                        const rect = el.getBoundingClientRect();
                        const headerEle = 0
                        let y = 0;
                        y = rect.top - headerEle;
                        const ul = page;
                        ul.scrollBy(0, y)
                    } catch (e) {
                        console.error(e);
                    }
                }
            })
            return divwrapper;
        }
        function getItem(c) {
            const item = document.createElement("li");
            item.classList.add("item");
            item.onclick = (evt) => {
                onSelectCity(c)
                if (allItems) {
                    for (let i = 0; i < allItems.length; i++) {
                        const it = allItems[i];
                        it.setAttribute("selected", "false");
                        it.classList.remove("selected");
                    }
                }
                const selected = item.getAttribute('selected') == 'true';
                if (selected) {
                    item.setAttribute("selected", "false")
                    item.classList.remove("selected");
                } else {
                    item.setAttribute("selected", 'true')
                    item.classList.add("selected");
                }
            }
            const label = document.createElement("label");
            label.textContent = c.Name;
            item.append(label);
            if (!allItems.find(it => it == item)) {
                allItems.push(item)
            }
            return item;
        }
        function getLeter2Cities(cities) {
            const cmap = {};
            if (cities) {
                cities.forEach(c => {
                    const arr = cmap[c.FirstLetter];
                    if (arr) {
                        if (!arr.find(it => it.Code == c.Code)) { arr.push(c) }
                    } else {
                        cmap[c.FirstLetter] = [c];
                    }
                })
            }
            return cmap;
        }
        function getLetterHeader(l) {
            const li = document.createElement("li");
            li.classList.add('letter-header');
            li.setAttribute("letter", l);
            const label = document.createElement("label");
            label.textContent = l;
            li.append(label);
            return li;
        }
        function getList(cmap) {
            const list = document.createElement("ul");
            list.classList.add("list")
            if (cmap) {
                const letters = Object.keys(cmap);
                letters.sort();
                if (letters && letters.length) {
                    letters.forEach(l => {
                        const letterHeader = getLetterHeader(l);
                        list.append(letterHeader);
                        const arr = cmap[l];
                        if (arr) {
                            arr.forEach(c => {
                                const item = getItem(c);
                                list.append(item);
                            })
                        }
                    })
                }
            }
            return list;
        }
    </script>
</body>

</html>