<ion-header>
  <ion-toolbar color="primary">
    <ion-title>登录</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content padding>
  <form [formGroup]="form">
    <section *ngIf="loginType == 'user'">
      <ion-row>
        <ion-col size="4">
          <ion-label position="floating">用户名</ion-label>
        </ion-col>
        <ion-col>
          <ion-input type="text" formControlName="Name" placeholder="用户名"></ion-input>
        </ion-col>
      </ion-row>
      <ion-row>
        <ion-col size="4">
          <ion-label position="floating">密码</ion-label>
        </ion-col>
        <ion-col>
          <ion-input type="password" placeholder="密码" formControlName="Password"></ion-input>
        </ion-col>
      </ion-row>
      <ion-row *ngIf="userErrorCount >= validImageCodeCount">
        <ion-col>
          <ion-label position="floating">图片验证码</ion-label>
        </ion-col>
        <ion-col>
          <ion-input type="text" text-uppercase formControlName="ImageCode" placeholder="图片验证码" maxlength="4">
          </ion-input>
        </ion-col>
        <ion-col class="image-code" text-center>
          <img *ngIf="(imgSrc$ | async) as url; else loadingUrl" [src]="url" alt="{{ url }}"
            (click)="refreshImageCode()" />
          <ng-template #loadingUrl>
            <img [style.height.em]='2.3' src="assets/images/loading.gif" alt="验证码" (click)="refreshImageCode()" />
          </ng-template>
        </ion-col>
      </ion-row>
    </section>
    <section *ngIf="loginType == 'mobile'">
      <ion-row>
        <ion-col size="3">
          <ion-label position="floating">手机号</ion-label>
        </ion-col>
        <ion-col>
          <ion-input placeholder="手机号" formControlName="Mobile" type="number" min="11"></ion-input>
        </ion-col>
        <ion-col size="4" *ngIf="!countDown || countDown <= 0; else countdownEle">
          <ion-button size="small" fill="outline" color="primary" [disabled]="!isMobileNumberOk"
            (click)="sendLoginMobileCode()">
            <span [style.font-size.rem]="0.8">发送验证码</span>
          </ion-button>
        </ion-col>
        <ng-template #countdownEle>
          <ion-col class="down-count" size="2">
            <ion-label color="medium">{{ countDown }} s</ion-label>
          </ion-col>
        </ng-template>
      </ion-row>

      <ion-row *ngIf="phoneErrorCount >= validImageCodeCount">
        <ion-col>
          <ion-label position="floating">验证码</ion-label>
        </ion-col>
        <ion-col>
          <ion-input type="text" maxlength="4" text-uppercase formControlName="ImageCode" placeholder="右边图片内容">
          </ion-input>
        </ion-col>
        <ion-col *ngIf="(imgSrc$ | async) as url" class="image-code" text-center>
          <img [src]="url" alt="{{ url }}" (click)="refreshImageCode()" />
        </ion-col>
      </ion-row>
      <ion-row>
        <ion-col size="4">
          <ion-label position="floating">短信验证码</ion-label>
        </ion-col>
        <ion-col>
          <ion-input placeholder="请输入收到短信验证码" formControlName="MobileCode"></ion-input>
        </ion-col>
      </ion-row>
    </section>
    <!-- <ion-button expand='block' (click)='getWechatCode()'>获取微信登陆code</ion-button> -->
    <ion-button (click)="login()" [disabled]="form.invalid || (loading$ | async)" expand="block">登录</ion-button>
    <ion-item lines='none'>
      <ion-note color="danger" *ngIf="message">{{ message }}</ion-note>
      <ion-button size="small" color="success" slot="end">
        <span *ngIf="loginType == 'user'" (click)="switchLoginType('mobile')">手机号登录</span>
        <span *ngIf="loginType != 'user'" (click)="switchLoginType('user')">用户名登录</span>
      </ion-button>
    </ion-item>
    <app-or-comp>第三方登陆</app-or-comp>
    <ion-item (click)='loginByWechat()' lines='none' text-center *ngIf="!isApp">
      <div class='third-party-logo'>
        <ion-thumbnail >
          <img src="assets/images/weixin-logo.png" alt="微信图标">
        </ion-thumbnail>
      </div>
    </ion-item>
  </form>
</ion-content>