<ion-header>
  <ion-toolbar>
    <ion-buttons slot='start'>
      <ion-button (click)='back()'>
        <ion-icon class='back-icon' name='arrow-back'></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>确认信息</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <ng-container *ngIf='!errors else errorTemp'>
    <ion-list *ngFor='let item of vmCombindInfos'>
      <ion-item-divider color='primary' sticky>
        {{item?.modal?.credential?.CheckName}}
        【{{tmc?.Name}}】
        [成人]
        {{item?.modal?.credential?.Number}}
      </ion-item-divider>
      <ion-item lines='none' class="ion-no-margin">
        <ion-label>通知语言:</ion-label>
        <ion-select value='cn' okText="确定" cancelText="取消" [(ngModel)]='item.notifyLanguage'>
          <ion-select-option value=''>不发</ion-select-option>
          <ion-select-option value='cn'>中文</ion-select-option>
          <ion-select-option value='en'>英文</ion-select-option>
        </ion-select>
      </ion-item>
      <ion-item lines='none' class="ion-no-margin" *ngIf='tmc?.FlightApprovalType!=0 
          && tmc?.FlightApprovalType!= tmcApprovalTypeNone 
          && bookTypeNotSelf() 
          && !identity?.Numbers?.AgentId'>
        <ion-label style='margin-right: 0.5em'>跳过审批:</ion-label>
        <ion-checkbox color="secondary" [(ngModel)]='item.isSkipApprove'></ion-checkbox>
      </ion-item>
      <ion-item lines='none' class="ion-no-margin" *ngIf='tmc?.IsShowServiceFee || identity?.Numbers?.AgentId'>
        <ion-label>服务费:</ion-label>
        <ion-input hidden value='getServiceFee(item?.modal?.credential)'></ion-input>
      </ion-item>
      <ion-item class="ion-no-margin" lines='none' detail *ngIf='isAllowSelectApprove(item)'
        (click)='openApproverModal(item)'>
        <ion-label>
          审批人:{{item?.appovalStaff?.Name}}|{{item?.appovalStaff?.Email||item?.appovalStaff?.Account?.Email}}|{{item?.appovalStaff?.Number}}
        </ion-label>
      </ion-item>
      <ion-item *ngFor='let s of item?.modal?.selectedInfo' class='ion-margin-vertical'>
        <div style='width: 100%' class='detail'>
          <div class='date'>
            <strong>{{getDate(s?.flightSegment)}} <ion-text color='secondary'>
                {{s?.flightSegment?.FromCityName}}
                <ion-text color='dark' class='small-font'>到</ion-text>
                {{s?.flightSegment?.ToCityName}}
                {{getTripTip(s)}}
                <span class='small-font'>【{{s?.flightPolicy?.Cabin?.Discount|discount}}】</span>
              </ion-text>
            </strong>
          </div>
          <app-fly-list-item [flightSegment]='s.flightSegment' [showDetails]='true' [flightPolicy]='s.flightPolicy'>
          </app-fly-list-item>
          <div class='price'>
            <ion-label color='danger'>￥{{s.flightPolicy?.Cabin?.TicketPrice}}</ion-label>
            <ion-label color='danger'>税:￥{{s.flightSegment?.Tax}}</ion-label>
          </div>
          <ion-button fill='clear' class='change-policy-btn' (click)='onShowFriendlyReminder(item)' color='secondary'>
            温馨提醒
            <ion-icon name="arrow-dropdown" *ngIf='item?.showFriendlyReminder'></ion-icon>
            <ion-icon name="arrow-dropright" *ngIf='!item?.showFriendlyReminder'></ion-icon>
          </ion-button>
          <ion-label [@openclose]='item?.showFriendlyReminder' text-wrap color='success' class='small-font'>
            温馨提醒: 国内廉价航司机票部分舱位不包含免费托运行李服务，免费托运行李相关事宜可以拨打我们客服电话咨询。（例如： 中联航:
            每位旅客可携带1件免费随身行李，重量不能超过10千克且体积不超过20×30×40厘米。托运行李收费标准：X ≤ 5KG 柜台价格30元； 5KG &lt; X ≤ 10KG 柜台价格60元； 10KG &lt; X
            ≤
            15KG
            柜台价格90元； 15KG &lt; X ≤ 20KG 柜台价格120元；等） </ion-label>
          <ion-label text-wrap color='danger' class='small-font' *ngIf='s?.flightPolicy?.Rules?.length'>
            超标：{{s?.flightPolicy?.Rules?.join(",")}}
          </ion-label>
          <ion-button fill='clear' class='change-policy-btn' (click)='openrules(item)' color='secondary'>
            退改签政策
            <ion-icon name="arrow-dropdown" *ngIf='item?.openrules'></ion-icon>
            <ion-icon name="arrow-dropright" *ngIf='!item?.openrules'></ion-icon>
          </ion-button>
          <div class='refund-change-info' [@openclose]='item?.openrules'>
            <ion-label text-wrap *ngIf='s?.flightPolicy?.Cabin?.RefundChange?.RefundDetail?.Befores?.length'>
              退票规则:{{s?.flightPolicy?.Cabin?.RefundChange?.RefundDetail?.Befores?.join("")}}
            </ion-label>
            <ion-label text-wrap *ngIf='s?.flightPolicy?.Cabin?.RefundChange?.ChangeDetail?.Befores?.length'>
              改期规则:{{s?.flightPolicy?.Cabin?.RefundChange?.ChangeDetail?.Befores?.join("")}}
            </ion-label>
            <ion-label text-wrap *ngIf='s?.flightPolicy?.Cabin?.RefundChange?.EndorsementDetail?.Endorsements?.length'>
              其它规则:{{s?.flightPolicy?.Cabin?.RefundChange?.EndorsementDetail?.Endorsements?.join("")}}
            </ion-label>
          </div>
          <div style='width: 100%' *ngIf='item?.vmCredential'>
            <ion-grid class="id-type" [class.disabled]='!modifyele.checked'>
              <ion-row>
                <ion-col>证件:</ion-col>
                <ion-col text-end>
                  <input class='hidden' type="checkbox" #modifyele>
                  <ion-button fill='clear' color='secondary' size='small'
                    (click)='modifyele.checked=!modifyele.checked'>
                    <ion-icon name="checkmark" mode='md' size='small' slot='start' color='success'
                      *ngIf='modifyele.checked'></ion-icon>
                    <ion-icon name="create" mode='md' size='small' slot='start' *ngIf='!modifyele.checked'></ion-icon>
                    <ion-text *ngIf='!modifyele.checked'>修改</ion-text>
                    <ion-text *ngIf='modifyele.checked'>保存</ion-text>
                  </ion-button>
                </ion-col>
              </ion-row>
              <ion-row>
                <ion-col>
                  <ion-item lines='none' no-margin no-padding [disabled]='!modifyele.checked'>
                    <ion-label>证件类型</ion-label>
                    <ion-select [(ngModel)]='item.vmCredential' name='Type' okText="确定" cancelText="取消"
                      selectedText='{{(item?.vmCredential?.Type|credential)}}' [compareWith]='compareFn'>
                      <ion-select-option [value]="opt" *ngFor='let opt of item?.credentials'>
                        {{(opt?.Type|credential)}}{{opt?.Number}}
                      </ion-select-option>
                    </ion-select>
                    <input type="text" value="{{item.vmCredential.Type}}" hidden ValidateName="Type">
                  </ion-item>
                </ion-col>
              </ion-row>
              <ion-row>
                <ion-col>证件号码：</ion-col>
                <ion-col>
                  <input type="text" [disabled]='!modifyele.checked' [(ngModel)]='item.vmCredential.Number'
                    name='Number' ValidateName="Number">
                </ion-col>
              </ion-row>
              <ion-row>
                <ion-col>登机姓：</ion-col>
                <ion-col>
                  <input type="text" [disabled]='!modifyele.checked' [(ngModel)]='item.vmCredential.CheckFirstName'
                    ValidateName='CheckFirstName' name='CheckFirstName'>
                </ion-col>
              </ion-row>
              <ion-row>
                <ion-col>登机名：</ion-col>
                <ion-col>
                  <input type="text" [disabled]='!modifyele.checked' [(ngModel)]='item.vmCredential.CheckLastName'
                    ValidateName='CheckLastName' name='CheckLastName'>
                </ion-col>
              </ion-row>
            </ion-grid>
            <div>
              <ng-template #exceedReasonTemp>超标原因：</ng-template>
              <ion-item lines='none' no-margin no-padding
                *ngIf='illegalReasons?.length&&s?.flightPolicy?.Rules?.length else exceedReasonTemp'>
                <ion-label>超标原因：</ion-label>
                <ion-select [disabled]='item?.isOtherIllegalReason' [(ngModel)]='item.illegalReason' name='Type'
                  okText="确定" cancelText="取消">
                  <ion-select-option [value]="opt?.Name" *ngFor='let opt of illegalReasons'>
                    {{opt?.Name}}
                  </ion-select-option>
                </ion-select>
              </ion-item>
              <div *ngIf='tmc?.IsAllowCustomReason'>
                <ion-item lines='none' no-margin no-padding>
                  <ion-label style='margin-right: 0'>其他原因:</ion-label>
                  <ion-checkbox color="secondary" [(ngModel)]="item.isOtherIllegalReason"></ion-checkbox>
                  <ion-input [disabled]='!item?.isOtherIllegalReason' [(ngModel)]='item.otherIllegalReason'
                    placeholder='请输入其他原因'></ion-input>
                </ion-item>
              </div>
            </div>
            <div [class.disabled]='item?.isOtherCostCenter'>
              <ion-item detail lines='none' [disabled]='item?.isOtherCostCenter' no-margin no-padding
                (click)='searchCostCenter(item)'>
                <ion-label>成本中心：</ion-label>
                <ion-label text-end>{{item?.costCenter?.name}}</ion-label>
              </ion-item>
              <ion-item lines='none' no-margin no-padding>
                <ion-label style='margin-right: 0.5em'>其他:</ion-label>
                <ion-checkbox color="secondary" [(ngModel)]="item.isOtherCostCenter"></ion-checkbox>
                <ion-input [disabled]='!item?.isOtherCostCenter' [(ngModel)]='item.otherCostCenterName'
                  placeholder='名称'>
                </ion-input>
                <ion-input [disabled]='!item?.isOtherCostCenter' [(ngModel)]='item.otherCostCenterCode'
                  placeholder='代码'>
                </ion-input>
              </ion-item>
            </div>
            <div [class.disabled]='item?.isOtherOrganization'>
              <ion-item detail lines='none' [disabled]='item?.isOtherOrganization' no-margin no-padding
                (click)='searchOrganization(item)'>
                <ion-label>部门：</ion-label>
                <ion-label text-end>{{item?.organization?.Name}}</ion-label>
              </ion-item>
              <ion-item lines='none' no-margin no-padding>
                <ion-label style='margin-right: 0.5em'>其他:</ion-label>
                <ion-checkbox color="secondary" [(ngModel)]="item.isOtherOrganization"></ion-checkbox>
                <ion-input [disabled]='!item?.isOtherOrganization' [(ngModel)]='item.otherOrganizationName'
                  placeholder='名称'>
                </ion-input>
              </ion-item>
            </div>
            <div class='mobiles'>
              联系方式:
              <ion-item *ngFor='let mobile of item?.credentialStaffMobiles'>
                <ion-checkbox color="secondary" [(ngModel)]="mobile.checked"></ion-checkbox>
                <ion-label style='margin-left: 0.5em'>{{mobile.mobile}}</ion-label>
              </ion-item>
              <ion-item>
                <ion-label style='margin-right: 0.5em'>其他号码：</ion-label>
                <ion-input [(ngModel)]="item.credentialStaffOtherMobile"></ion-input>
              </ion-item>
            </div>
            <div class='emails'>
              联系邮箱:
              <ion-item *ngFor='let email of item?.credentialStaffEmails'>
                <ion-checkbox color="secondary" [(ngModel)]="email.checked"></ion-checkbox>
                <ion-label style='margin-left: 0.5em'>{{email.email}}</ion-label>
              </ion-item>
              <ion-item>
                <ion-label style='margin-right: 0'>其他邮箱</ion-label>
                <ion-input [(ngModel)]="item.credentialStaffOtherEmail"></ion-input>
              </ion-item>
            </div>
            <div *ngIf='item?.insuranceResultProducts.length'>
              保险:
              <div *ngFor='let insurance of item?.insuranceResultProducts?.slice(0,1)'>
                <ion-row>
                  <ion-col size='9'>
                    <ion-item>
                      <ion-checkbox color="secondary" name='insurance' [(ngModel)]="insurance.checked">
                      </ion-checkbox>
                      <ion-label style='margin-left: 0.5em'>
                        {{insurance.insuranceResult?.Name}}({{insurance.insuranceResult?.Price}}元)</ion-label>
                    </ion-item>
                  </ion-col>
                  <ion-col size='3'>
                    <ion-button fill='clear' (click)='insuranceEle.checked=!insuranceEle.checked' color='secondary'>
                      详情
                      <ion-icon name="arrow-dropdown" *ngIf='insuranceEle.checked'></ion-icon>
                      <ion-icon name="arrow-dropright" *ngIf='!insuranceEle.checked'></ion-icon>
                    </ion-button>
                  </ion-col>
                </ion-row>
                <input type="checkbox" #insuranceEle class='hidden'>
                <ion-label text-wrap class='small-font' [@openclose]='insuranceEle.checked'>
                  {{insurance.insuranceResult?.Detail}}
                </ion-label>
              </div>
            </div>
            <div *ngIf="true">
              审批人:
              <ion-row margin-top>
                <ion-col>
                  <app-fly-timeline [hideLastTimeLineTail]='false'>
                    <app-fly-timeline-item *ngFor='let it of item?.credentialStaffApprovers'>
                      第{{it.Tag}}级审批:
                      <ion-label text-wrap *ngFor='let ap of it.approvers;let last'>
                        {{ap.Account?.RealName}}({{it?.Type==1?"所有通过":"任意通过"}})
                      </ion-label>
                    </app-fly-timeline-item>
                  </app-fly-timeline>
                </ion-col>
              </ion-row>
            </div>
          </div>
          <div class='outnumber' *ngIf='item?.tmcOutNumberInfos'>
            外部编号：
            <ion-item-group>
              <ion-item *ngFor='let n of item?.tmcOutNumberInfos' (click)='onSelectTravelNumber(n,item)'>
                <ion-label>{{n.label}}:</ion-label>
                <ion-input [disabled]='n.isDisabled' [value]='n.value' placeholder="{{n.label}}"></ion-input>
              </ion-item>
            </ion-item-group>
          </div>
          <div class='travel-type'>
            <ion-radio-group [(ngModel)]='item.travelType' name='travelType'>
              <ion-item *ngIf='checkOrderTravelType(orderTravelType.Business)' lines='none'>
                <ion-label>因公</ion-label>
                <ion-radio [value]="orderTravelType.Business"
                  [checked]='checkOrderTravelType(orderTravelType.Business)'></ion-radio>
              </ion-item>

              <ion-item *ngIf='checkOrderTravelType(orderTravelType.Person)' lines='none'>
                <ion-label>因私</ion-label>
                <ion-radio [value]="orderTravelType.Person" [checked]='checkOrderTravelType(orderTravelType.Person)'>
                </ion-radio>
              </ion-item>
            </ion-radio-group>
          </div>
          <div>
            支付方式：
            <ion-radio-group [(ngModel)]='item.orderTravelPayType' name='travelPayType'>
              <ng-container *ngFor='let pt of orderTravelPayTypes'>
                <ion-item *ngIf='checkOrderTravelPayType(pt.value)' lines='none'>
                    <ion-label>{{pt.label}}</ion-label>
                    <ion-radio [value]="pt.value" [checked]='tmc?.FlightPayType==pt.value'>
                    </ion-radio>
                </ion-item>
              </ng-container>
            </ion-radio-group>
          </div>
          <div class='link-man'>
            添加联系人:
            <ion-row *ngFor='let man of item?.addContacts'>
              <ion-col size='12'>
                <ion-item lines='none' class="ion-no-margin">
                  <ion-label>旅客名称:</ion-label>
                  <ion-input name='name' [(ngModel)]='man.name'></ion-input>
                </ion-item>
              </ion-col>
              <ion-col size='12'>
                <ion-item lines='none' class="ion-no-margin">
                  <ion-label>手机号:</ion-label>
                  <ion-input name='mobile' [(ngModel)]='man.mobile'></ion-input>
                </ion-item>
              </ion-col>
              <ion-col size='12'>
                <ion-item lines='none' class="ion-no-margin">
                  <ion-label>邮箱:</ion-label>
                  <ion-input name='email' [(ngModel)]='man.email'></ion-input>
                </ion-item>
              </ion-col>
              <ion-col size='12'>
                <ion-item lines='none' class="ion-no-margin">
                  <ion-label>通知语言:</ion-label>
                  <ion-select value="cn" okText="确定" cancelText="取消" [(ngModel)]='man.notifyLanguage'>
                    <ion-select-option value=''>不发</ion-select-option>
                    <ion-select-option value='cn'>中文</ion-select-option>
                    <ion-select-option value='en'>英文</ion-select-option>
                  </ion-select>
                </ion-item>
              </ion-col>
            </ion-row>
            <ion-row>
              <ion-col>
                <ion-button fill='outline' expand='block' color='secondary' (click)='onAddContacts(item)'>
                  <ion-icon name="add-circle-outline" color='secondary' slot='start'></ion-icon> 添加联系人
                </ion-button>
              </ion-col>
            </ion-row>
          </div>
        </div>
      </ion-item>
    </ion-list>
  </ng-container>
  <ng-template #errorTemp>
    <ion-row style="position: relative;top:35%">
      <ion-col text-center>
        <ion-label color='danger'>请求数据出错</ion-label>
        <ion-button fill='clear' expand='block' color='secondary' (click)='refresh()'>点击重试</ion-button>
      </ion-col>
    </ion-row>
  </ng-template>
</ion-content>
<ion-footer>
  <ion-toolbar>
    <ion-buttons slot='start'>
      <ion-button color='secondary'>总计:
        <ion-text slot='end' color='danger'>￥{{(totalPriceSource|async)|flightprice:"1"}}</ion-text>
      </ion-button>
    </ion-buttons>
    <ion-buttons slot='end'>
      <ion-button color='secondary' (click)='bookFlight()'> 提交</ion-button>
    </ion-buttons>
    <ion-buttons slot='end'>
      <ion-button color='secondary'>保存订单</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-footer>